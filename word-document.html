<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Word Processor</title>
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="root.css" />
    <link rel="stylesheet" href="styles/as.css" />
  </head>
  <body>
    <div class="flex h-screen w-full fm text-c-black">
      <!--Comment section-->
      <div
        id="comments"
        class="fixed flex h-full flex-col border-r bg-c-lighten-gray hidden md:w-1/3 xl:w-1/5 font-size-14"
      >
        <div
          class="resizer absolute top-0 right-0 w-1 h-full"
          style="cursor: ew-resize; background-color: #d1d5db"
        ></div>
        <div
          class="sticky top-0 z-10 flex items-center justify-between border-b px-4 py-2"
        >
          <h3 class="font-medium font-size-16">Comments</h3>
          <div>
            <button class="pr-2" onclick="togglePane('addcomment')">
              <i class="ri-chat-new-line ri-lg"></i>
            </button>
            <button onclick="togglePane('comments')">
              <i class="ri-close-fill ri-lg"></i>
            </button>
          </div>
        </div>
        <!--chat list-->
        <div class="flex-1 overflow-auto" id="comment-list">
          <div class="space-y-4 p-4">
            <div class="grid gap-2 border-b">
              <div class="flex items-start gap-3">
                <div class="h-8 w-8 rounded-full">
                  <img
                    src="images/avatar.png"
                    alt="Avatar"
                    class="h-8 w-8 rounded-full"
                  />
                </div>
                <div class="flex-1 space-y-1">
                  <div class="flex items-center justify-between">
                    <div class="font-medium">John Doe</div>
                    <div class="text-xs">10-07-2024 10:45</div>
                  </div>
                  <p>This is a great document! I have a few suggestions...</p>
                  <div class="flex items-center gap-2">
                    <button class="p-2">
                      <i class="ri-reply-line"></i>
                    </button>
                    <button class="p-2">
                      <i class="ri-delete-bin-line"></i>
                    </button>
                  </div>
                </div>
              </div>
              <div class="ml-11 grid gap-2">
                <div class="flex items-start gap-3">
                  <div class="h-8 w-8 rounded-full">
                    <img
                      src="images/avatar.png"
                      alt="Avatar"
                      class="h-8 w-8 rounded-full"
                    />
                  </div>
                  <div class="flex-1 space-y-1">
                    <div class="flex items-center justify-between">
                      <div class="font-medium">Sarah Anderson</div>
                      <div class="text-xs">1 hour ago</div>
                    </div>
                    <p>
                      I agree, those are great suggestions. Let me add a few
                      more...
                    </p>
                    <div class="flex items-center gap-2">
                      <button class="p-2">
                        <i class="ri-reply-line"></i>
                      </button>
                      <button class="p-2">
                        <i class="ri-delete-bin-line"></i>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
              <div class="ml-11 grid gap-2">
                <div class="flex items-start gap-3">
                  <div class="h-8 w-8 rounded-full">
                    <img
                      src="images/avatar.png"
                      alt="Avatar"
                      class="h-8 w-8 rounded-full"
                    />
                  </div>
                  <div class="flex-1 space-y-1">
                    <div class="flex items-center justify-between">
                      <div class="font-medium">Sarah Anderson</div>
                      <div class="text-xs">1 hour ago</div>
                    </div>
                    <p>
                      I agree, those are great suggestions. Let me add a few
                      more...
                    </p>
                    <div class="flex items-center gap-2">
                      <button class="p-2">
                        <i class="ri-reply-line"></i>
                      </button>
                      <button class="p-2">
                        <i class="ri-delete-bin-line"></i>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="grid gap-2">
              <div class="flex items-start gap-3">
                <div class="h-8 w-8 rounded-full">
                  <img
                    src="images/avatar.png"
                    alt="Avatar"
                    class="h-8 w-8 rounded-full"
                  />
                </div>
                <div class="flex-1 space-y-1">
                  <div class="flex items-center justify-between">
                    <div class="font-medium">John Doe</div>
                    <div class="text-xs">10-07-2024 10:45</div>
                  </div>
                  <p>This is a great document! I have a few suggestions...</p>
                  <div class="flex items-center gap-2">
                    <button class="p-2">
                      <i class="ri-reply-line"></i>
                    </button>
                    <button class="p-2">
                      <i class="ri-delete-bin-line"></i>
                    </button>
                  </div>
                </div>
              </div>
              <div class="ml-11 grid gap-2">
                <div class="flex items-start gap-3">
                  <div class="h-8 w-8 rounded-full">
                    <img
                      src="images/avatar.png"
                      alt="Avatar"
                      class="h-8 w-8 rounded-full"
                    />
                  </div>
                  <div class="flex-1 space-y-1">
                    <div class="flex items-center justify-between">
                      <div class="font-medium">Sarah Anderson</div>
                      <div class="text-xs">1 hour ago</div>
                    </div>
                    <p>
                      I agree, those are great suggestions. Let me add a few
                      more...
                    </p>
                    <div class="flex items-center gap-2">
                      <button class="p-2">
                        <i class="ri-reply-line"></i>
                      </button>
                      <button class="p-2">
                        <i class="ri-delete-bin-line"></i>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!--Add comment-->
        <div
          id="addcomment"
          class="sticky bottom-0 z-10 border-t px-4 py-2 hidden"
        >
          <!-- Mention list -->
          <div
            id="mentionList"
            class="absolute hidden bg-c-white border border-c-medium-gray rounded-md shadow-lg z-20 max-h-40 overflow-y-auto bottom-full"
          >
            <!-- Mention items will be dynamically inserted here -->
          </div>
          <div class="flex items-center gap-2 relative">
            <div class="flex-1 relative">
              <textarea
                id="commentTextarea"
                placeholder="Write a new comment..."
                class="w-full rounded-md border border-c-medium-gray p-2 text-sm focus:outline-none bg-transparent relative z-10 text-transparent caret-black"
                rows="4"
                style="caret-color: black"
              ></textarea>
              <div
                id="styledTextarea"
                class="absolute top-0 left-0 w-full h-full p-2 text-sm pointer-events-none whitespace-pre-wrap break-words overflow-hidden bg-transparent"
              ></div>
            </div>
            <button
              class="border px-3 hover-bg-c-black hover-text-c-yellow text-sm py-1 rounded border-gray-600 bg-c-yellow"
            >
              Post
            </button>
          </div>
        </div>
      </div>
      <!--Iframe-->
      <div class="flex-1" id="frame">
        <div class="overflow-auto relative">
          <div class="prose max-w-none">
            <iframe
              id="iframe{{ $iframe['filetype'].$iframefile['filekey'] }}"
              src="https://desktop2.sizaf.com/filemanager/Desktop"
              class="w-full h-screen"
            ></iframe>
            <div
              class="absolute bottom-5 left-5 bg-gray-300 rounded-full px-2 py-1"
            >
              <button onclick="togglePane('comments')">
                <i class="ri-chat-4-line ri-lg"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
    <script>
      const comment = document.getElementById("comments");
      const frame = document.getElementById("frame");
      const resizer = document.querySelector(".resizer");
      const commentList = document.getElementById("comment-list");
      const mentionList = document.getElementById("mentionList");
      const textarea = document.getElementById("commentTextarea");
      const styledTextarea = document.getElementById("styledTextarea");

      // Toggle visibility of the comments pane
      function togglePane(id) {
        let element = document.getElementById(id);
        element.classList.toggle("hidden");
        if (!element.classList.contains("hidden")) {
          scrollToBottom();
        }
        updateFrameMargin();
      }

      // Scroll to the bottom of the comment list
      function scrollToBottom() {
        commentList.scrollTop = commentList.scrollHeight;
      }

      // Update the margin of the frame based on the comments pane width
      function updateFrameMargin() {
        const margin = !comment.classList.contains("hidden")
          ? `${comment.offsetWidth}px`
          : "0";
        frame.style.marginLeft = margin;
      }

      let startX, startWidth;

      // Initialize the resizing of the comment section
      const initResize = (e) => {
        e.preventDefault();
        startX = e.clientX;
        startWidth = comment.offsetWidth;

        window.addEventListener("mousemove", startResizing);
        window.addEventListener("mouseup", stopResizing);
      };

      // Start resizing the comment section
      const startResizing = (e) => {
        const minWidth = 288;
        const maxWidth = 500;
        let newWidth = startWidth + (e.clientX - startX);

        if (newWidth < minWidth) newWidth = minWidth;
        else if (newWidth > maxWidth) newWidth = maxWidth;

        comment.style.width = `${newWidth}px`;
        console.log("newWidth", newWidth);
        console.log("comment", comment.style.width);
        updateFrameMargin();
      };

      // Stop resizing the comment section
      const stopResizing = () => {
        window.removeEventListener("mousemove", startResizing);
        window.removeEventListener("mouseup", stopResizing);
      };

      resizer.addEventListener("mousedown", initResize);

      // Update frame margin initially in case the comments section is not hidden
      updateFrameMargin();

      // Array of users for mention suggestions
      const users = [
        { id: 1, name: "John Doe" },
        { id: 2, name: "Sarah Anderson" },
        { id: 3, name: "Michael Brown" },
      ];

      // Function to highlight @mentions in the textarea content
      function highlightMentions(text) {
        // Regex to find @mentions and wrap them with a span for styling
        const regex = /(@[a-zA-Z]+\s[a-zA-Z]+)/g;
        return text.replace(
          regex,
          (match) => `<span class="text-link-blue">${match}</span>`
        );
      }

      // Update the preview and display user suggestions as the user types
      textarea.addEventListener("input", (e) => {
        const value = e.target.value;
        const cursorPosition = e.target.selectionStart;
        const lastAtIndex = value.lastIndexOf("@", cursorPosition - 1);

        // Show highlighted mentions in the preview area
        styledTextarea.innerHTML =
          highlightMentions(value) +
          "<br>".repeat(textarea.rows - (value.match(/\n/g) || []).length);

        if (lastAtIndex !== -1) {
          const query = value.slice(lastAtIndex + 1, cursorPosition);
          const filteredUsers = users.filter((user) =>
            user.name.toLowerCase().includes(query.toLowerCase())
          );

          // Display filtered users in the mention list if there are matches
          if (filteredUsers.length > 0) {
            mentionList.innerHTML = filteredUsers
              .map(
                (user) =>
                  `<div class="px-4 py-2 hover-bg-c-yellow text-c-black cursor-pointer" data-name="${user.name}">${user.name}</div>`
              )
              .join("");
            const rect = textarea.getBoundingClientRect();
            mentionList.style.left = `${rect.left}px`;
            mentionList.style.width = `${textarea.offsetWidth}px`;
            mentionList.classList.remove("hidden");
          } else {
            mentionList.classList.add("hidden");
          }
        } else {
          mentionList.classList.add("hidden");
        }
      });

      // Insert the selected mention into the textarea and update the preview
      mentionList.addEventListener("click", (e) => {
        if (e.target.dataset.name) {
          const cursorPosition = textarea.selectionStart;
          const value = textarea.value;
          const lastAtIndex = value.lastIndexOf("@", cursorPosition - 1);

          // Replace the @mention with the selected user’s name
          const newValue =
            value.slice(0, lastAtIndex + 1) +
            e.target.dataset.name +
            " " +
            value.slice(cursorPosition);
          textarea.value = newValue;
          textarea.focus();
          textarea.setSelectionRange(
            lastAtIndex + 1 + e.target.dataset.name.length + 1,
            lastAtIndex + 1 + e.target.dataset.name.length + 1
          );

          // Update the preview area with the new text
          styledTextarea.innerHTML =
            highlightMentions(textarea.value) +
            "<br>".repeat(
              textarea.rows - (textarea.value.match(/\n/g) || []).length
            );

          // Hide the mention list after selection
          mentionList.classList.add("hidden");
        }
      });

      // Hide the mention list if the user clicks outside of the textarea or list
      document.addEventListener("click", (e) => {
        if (!mentionList.contains(e.target) && !textarea.contains(e.target)) {
          mentionList.classList.add("hidden");
        }
      });
    </script>
  </body>
</html>
